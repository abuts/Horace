<!DOCTYPE html>
<html class="writer-html5" lang="en">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>4. Correcting for sample misalignment &mdash; Horace  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js?v=b3ba4146"></script>
        <script src="../_static/doctools.js?v=888ff710"></script>
        <script src="../_static/sphinx_highlight.js?v=4825356b"></script>
        <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="5. Cutting data of interest from SQW files and objects" href="Cutting_data_of_interest_from_SQW_files_and_objects.html" />
    <link rel="prev" title="3. Data diagnostics" href="Data_diagnostics.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Horace
              <img src="../_static/150px-Quintus_Horatius_Flaccus.jpg" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Introduction.html">Introduction and Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../User_guide.html">User’s Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../Horace_manual.html">Horace Manual</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Planning_a_Horace_scan.html">1. Planning a Horace scan</a></li>
<li class="toctree-l2"><a class="reference internal" href="Generating_SQW_files.html">2. Generating SQW files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Data_diagnostics.html">3. Data diagnostics</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">4. Correcting for sample misalignment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1-determining-the-true-bragg-peak-positions">4.1. Step 1 - determining the true Bragg peak positions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#bragg-positions">4.1.1. Bragg Positions</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-2-check-the-bragg-positions-fits-worked-properly">4.1.2. Step 2 - check the Bragg positions fits worked properly</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-3-calculate-the-misalignment-correction">4.1.3. Step 3 - calculate the misalignment correction</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step-4-apply-the-correction-to-the-data">4.1.4. Step 4 - apply the correction to the data</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#option-1-apply-the-correction-to-an-existing-sqw-file">4.2. Option 1 : apply the correction to an existing sqw file</a></li>
<li class="toctree-l3"><a class="reference internal" href="#option-2-calculate-goniometer-offsets-for-regeneration-of-sqw-file-s">4.3. Option 2 : calculate goniometer offsets for regeneration of sqw file(s)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#option-2a-for-use-with-e-g-mslice-calculate-the-true-u-and-v-for-your-misaligned-crystal">4.4. Option 2a (for use with e.g. Mslice): calculate the true u and v for your misaligned crystal</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#list-of-alignment-correction-routines">4.4.1. List of alignment correction routines</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id1">4.5. bragg_positions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#bragg-positions-view">4.6. bragg_positions_view</a></li>
<li class="toctree-l3"><a class="reference internal" href="#crystal-pars-correct">4.7. crystal_pars_correct</a></li>
<li class="toctree-l3"><a class="reference internal" href="#refine-crystal">4.8. refine_crystal</a></li>
<li class="toctree-l3"><a class="reference internal" href="#ubmatrix">4.9. ubmatrix</a></li>
<li class="toctree-l3"><a class="reference internal" href="#uv-correct">4.10. uv_correct</a></li>
<li class="toctree-l3"><a class="reference internal" href="#rlu-corr-to-lattice">4.11. rlu_corr_to_lattice</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Cutting_data_of_interest_from_SQW_files_and_objects.html">5. Cutting data of interest from SQW files and objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="Special_sqw_information.html">6. Special <code class="docutils literal notranslate"><span class="pre">SQW</span></code> information from sqw objects and files</a></li>
<li class="toctree-l2"><a class="reference internal" href="Save_and_load.html">7. Loading <code class="docutils literal notranslate"><span class="pre">sqw</span></code> and <code class="docutils literal notranslate"><span class="pre">dnd</span></code> objects to memory</a></li>
<li class="toctree-l2"><a class="reference internal" href="Save_and_load.html#saving-sqw-objects-from-memory-and-creating-filebacked-objects">8. Saving sqw objects from memory and creating filebacked objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="Reshaping_etc.html">9. Other shape functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Symmetrising_etc.html">10. Symmetry Operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Unary_operations.html">11. Unary operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Binary_operations.html">12. Binary operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="Plotting.html">13. Plotting</a></li>
<li class="toctree-l2"><a class="reference internal" href="Simulation.html">14. Simulation</a></li>
<li class="toctree-l2"><a class="reference internal" href="Multifit.html">15. Multifit</a></li>
<li class="toctree-l2"><a class="reference internal" href="Tobyfit.html">16. Tobyfit</a></li>
<li class="toctree-l2"><a class="reference internal" href="Parallel.html">17. Running Horace in Parallel</a></li>
<li class="toctree-l2"><a class="reference internal" href="Changing_Horace_settings.html">18. Changing Horace settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="List_of_functions.html">List of functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="Input_file_formats.html">Input file formats</a></li>
<li class="toctree-l2"><a class="reference internal" href="FAQ.html">FAQ</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Example_scripts.html">Example Scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Citing.html">Citing Horace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Developers.html">For Developers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Contributing.html">Contributing to Horace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../General_disclaimer.html">General disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Previous_versions.html">Previous Versions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Horace</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../Horace_manual.html">Horace Manual</a></li>
      <li class="breadcrumb-item active"><span class="section-number">4. </span>Correcting for sample misalignment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/manual/Correcting_for_sample_misalignment.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="correcting-for-sample-misalignment">
<h1><span class="section-number">4. </span>Correcting for sample misalignment<a class="headerlink" href="#correcting-for-sample-misalignment" title="Permalink to this heading"></a></h1>
<p>When mounting your sample on a spectrometer, it can often be the case that it is slightly misaligned with respect to the
‘perfect’ alignment assumed when generating the SQW file (the <code class="docutils literal notranslate"><span class="pre">u</span></code> and <code class="docutils literal notranslate"><span class="pre">v</span></code> vectors provided in <code class="docutils literal notranslate"><span class="pre">gen_sqw</span></code> and
<code class="docutils literal notranslate"><span class="pre">accumulate_sqw</span></code>). It is straightforward to correct this misalignment, once enough data have been accumulated, by
comparing the positions of Bragg peaks with what they are expected to be.</p>
<p>Alignment correction is a two-step process:</p>
<ol class="arabic simple">
<li><p>First, the misalignment must be determined and checked.</p></li>
<li><p>Then, the correction must be applied to the data.</p></li>
</ol>
<section id="step-1-determining-the-true-bragg-peak-positions">
<h2><span class="section-number">4.1. </span>Step 1 - determining the true Bragg peak positions<a class="headerlink" href="#step-1-determining-the-true-bragg-peak-positions" title="Permalink to this heading"></a></h2>
<section id="bragg-positions">
<h3><span class="section-number">4.1.1. </span>Bragg Positions<a class="headerlink" href="#bragg-positions" title="Permalink to this heading"></a></h3>
<p>First you should identify several Bragg peaks which are strong and not parallel along <span class="math notranslate nohighlight">\(\{p \in{} P:
\Gamma{}\rightarrow{}p\}\)</span> in your data, where <span class="math notranslate nohighlight">\(\{P\}\)</span> is the set of Bragg peaks, where
<span class="math notranslate nohighlight">\(\Gamma{}\rightarrow{}p\)</span> is the path from the gamma point (<span class="math notranslate nohighlight">\([0,0,0]\)</span>) to the point <span class="math notranslate nohighlight">\(p\)</span>.</p>
<p>Henceforth, we define <span class="math notranslate nohighlight">\(\{\vec{Q}\}\)</span> as the set of vectors from the gamma point to each Bragg point <span class="math notranslate nohighlight">\(\{p
\in{} P: \vec{\Gamma{}p}\}\)</span>.</p>
<p>The following routine generates radial and transverse cuts around specified Bragg peaks and calculates the deviation
from the expected values.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">rlu0</span><span class="p">,</span><span class="w"> </span><span class="n">widths</span><span class="p">,</span><span class="w"> </span><span class="n">wcut</span><span class="p">,</span><span class="w"> </span><span class="n">wpeak</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">bragg_positions</span><span class="w"> </span><span class="p">(</span><span class="n">sqw</span><span class="p">,</span><span class="w"> </span><span class="n">bragg_positions</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                </span><span class="n">radial_cut_length</span><span class="p">,</span><span class="w"> </span><span class="n">radial_bin_width</span><span class="p">,</span><span class="w"> </span><span class="n">radial_thickness</span><span class="p">,</span><span class="k">...</span>
<span class="w">                </span><span class="n">trans_cut_length</span><span class="p">,</span><span class="w"> </span><span class="n">trans_bin_width</span><span class="p">,</span><span class="w"> </span><span class="n">trans_thickness</span><span class="p">,</span><span class="w"> </span><span class="k">...</span>
<span class="w">                </span><span class="n">energy_window</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">keyword</span><span class="w"> </span><span class="n">options</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>The inputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">sqw</span></code> - the uncorrected data</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bragg_positions</span></code> - an n-by-3 array specifying the expected Bragg positions</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">radial_cut_length</span></code> - lengths of the various cuts along each of <span class="math notranslate nohighlight">\(\{\vec{Q}\}\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">radial_bin_width</span></code> - bin (step) sizes along the radial cuts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">radial_thickness</span></code> - integration thickness along the axes perpendicular to the radial cut direction</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trans_cut_length</span></code> - lengths of cuts of each cut perpendicular to <span class="math notranslate nohighlight">\(\{\vec{Q}\}\)</span>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trans_bin_width</span></code> - bin (step) sizes along the transverse cuts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trans_thickness</span></code> - integration thickness along the two perpendicular directions to the transverse cuts</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">energy_window</span></code> - Energy integration window around elastic line (meV). Choose according to the instrument
resolution.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is the full energy window.  A good value for <code class="docutils literal notranslate"><span class="pre">energy_window</span></code> is 2 x full-width half-height,
e.g. for -1meV to +1 meV, set <code class="docutils literal notranslate"><span class="pre">energy_window=2</span></code></p>
</div>
<p>The following keyword options are available:</p>
<p>For binning:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'bin_absolute'</span></code> [Default] - denotes that the radial and transverse cut lengths, bin sizes, and thicknesses are in
inverse Angstroms</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'bin_relative'</span></code> - denotes that cut lengths, bin sizes and thicknesses are fractions of <span class="math notranslate nohighlight">\(\left|\mathbf{Q}\right|\)</span> for radial
cuts and degrees for transverse cuts.</p></li>
</ul>
<p>For fitting:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'outer'</span></code> [Default] - determines peak position from centre of peak half-height by finding the peak width moving inwards from
the limits of the data</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Useful if there is known to be a single peak in the data as it is more robust to too finely binned data.</p>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">'inner'</span></code> - determines the peak position from centre of peak half height by finding the peak width moving outwards
from peak maximum</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'gaussian'</span></code> - fits a Gaussian on a linear background.</p></li>
</ul>
<p>The outputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rlu0</span></code> - the actual peak positions as an n-by-3 matrix in <span class="math notranslate nohighlight">\(h,k,l\)</span> as indexed with respect to the current
lattice parameters.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">widths</span></code> - an n-by-3 array containing the FWHH in Ang^-1 of the peaks along each of the three projection axes</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">wcut</span></code> - an n-by-3 array of cuts, along three orthogonal directions through each Bragg point from which the
peak positions were determined.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These cuts are <code class="docutils literal notranslate"><span class="pre">IX_dataset_1d</span></code> objects and can be plotted using the plot functions.</p>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wpeak</span></code> - an n-by-3 array of spectra, that summarise the peak analysis.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>These cuts are <code class="docutils literal notranslate"><span class="pre">IX_dataset_1d</span></code> objects and can be plotted using the plot functions.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">wcut</span></code> and <code class="docutils literal notranslate"><span class="pre">wpeak</span></code> can be passed to <code class="docutils literal notranslate"><span class="pre">bragg_positions_view</span></code> to view the output.</p>
</div>
</section>
<section id="step-2-check-the-bragg-positions-fits-worked-properly">
<h3><span class="section-number">4.1.2. </span>Step 2 - check the Bragg positions fits worked properly<a class="headerlink" href="#step-2-check-the-bragg-positions-fits-worked-properly" title="Permalink to this heading"></a></h3>
<p>You can make plots of the cuts and fits of your predicted Bragg peaks to check that the program has correctly fitted
everything, using outputs from <code class="docutils literal notranslate"><span class="pre">bragg_positions</span></code> described above.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">bragg_positions_view</span><span class="p">(</span><span class="n">wcut</span><span class="p">,</span><span class="n">wpeak</span><span class="p">)</span>
</pre></div>
</div>
<p>You will be prompted in the Matlab command window as to which plot and fit you wish to view.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Press <code class="docutils literal notranslate"><span class="pre">'q'</span></code> to exit this interactive mode.</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>It is important to use this function to scrutinise the peaks and the fits because there many parameters that may need
adjusting depending on the degree of misalignment of your crystal: the length, binning and thicknesses of the cuts
you specified in <code class="docutils literal notranslate"><span class="pre">bragg_positions</span></code>, the quality of the cuts (for example the Bragg peaks may be near gaps in the
detectors so the cuts are poorly defined), the Bragg peaks may have strange shapes which can confuse the automatic
fitting, etc.</p>
</div>
</section>
<section id="step-3-calculate-the-misalignment-correction">
<h3><span class="section-number">4.1.3. </span>Step 3 - calculate the misalignment correction<a class="headerlink" href="#step-3-calculate-the-misalignment-correction" title="Permalink to this heading"></a></h3>
<p>Using the outputs of <code class="docutils literal notranslate"><span class="pre">bragg_positions</span></code>, you can determine a transformation matrix to go from the original
misaligned frame to the aligned frame.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">al_info</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">refine_crystal</span><span class="p">(</span><span class="n">rlu0</span><span class="p">,</span><span class="w"> </span><span class="n">alatt</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg</span><span class="p">,</span><span class="w"> </span><span class="n">bragg_peaks</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">keyword</span><span class="w"> </span><span class="n">options</span><span class="o">&gt;</span><span class="p">);</span>
</pre></div>
</div>
<p>The inputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">rlu0</span></code> - the an n-by-3 matrix of actual peak positions as in <span class="math notranslate nohighlight">\(h,k,l\)</span> as indexed with the current lattice parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alatt,</span> <span class="pre">angdeg</span></code> - the lattice parameters and angles used in the original sqw file.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bragg_peaks</span></code> - the predicted (integer) Bragg peaks corresponding to <code class="docutils literal notranslate"><span class="pre">rlu0</span></code></p></li>
</ul>
<p>The keyword options are:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">fix_lattice</span></code> - Fix all lattice parameters <span class="math notranslate nohighlight">\([a,b,c,\alpha,\beta,\gamma]\)</span>, i.e. only allow crystal orientation
to be refined</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fix_alatt</span></code> - Fix <span class="math notranslate nohighlight">\([a,b,c]\)</span>, but allow lattice angles <span class="math notranslate nohighlight">\([\alpha,\beta,\gamma]\)</span> to be refined together with
the crystal orientation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fix_angdeg</span></code> - Fix <span class="math notranslate nohighlight">\([\alpha,\beta,\gamma]\)</span>, but allow the lattice parameters <span class="math notranslate nohighlight">\([a,b,c]\)</span> to be refined together with crystal orientation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fix_alatt_ratio</span></code> Fix the ratio of the lattice parameters as given by the values in the inputs, but allow the
overall scale of the lattice to be refined together with crystal orientation</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fix_orient</span></code> - Fix the crystal orientation i.e. only refine the lattice parameters</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">free_alatt</span></code> - Array length 3 of booleans, 1=free, 0=fixed</p>
<p>e.g. <code class="docutils literal notranslate"><span class="pre">'free_alatt',[0,1,0],...</span></code> allows only lattice parameter <span class="math notranslate nohighlight">\(b^{*}\)</span> to vary</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">free_angdeg</span></code> - Array length 3 of booleans, 1=free, 0=fixed.</p>
<p>e.g. <code class="docutils literal notranslate"><span class="pre">'free_angdeg',[1,1,0],...</span></code> fixes lattice angle gamma buts allows <span class="math notranslate nohighlight">\(\alpha\)</span> and <span class="math notranslate nohighlight">\(\beta\)</span> to vary</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>To achieve finer control of the refinement of the lattice parameters, use <code class="docutils literal notranslate"><span class="pre">free_alatt</span></code> and <code class="docutils literal notranslate"><span class="pre">free_angdeg</span></code></p>
</div>
<p>The output is an <code class="docutils literal notranslate"><span class="pre">crystal_alignment_info</span></code> object which contains all the relevant data for crystal realignment.</p>
</section>
<section id="step-4-apply-the-correction-to-the-data">
<h3><span class="section-number">4.1.4. </span>Step 4 - apply the correction to the data<a class="headerlink" href="#step-4-apply-the-correction-to-the-data" title="Permalink to this heading"></a></h3>
<p>There are different to do this, for different circumstances:</p>
<ul>
<li><p>When you have a completed scan and an existing <code class="docutils literal notranslate"><span class="pre">sqw</span></code> file:</p>
<p>Apply the correction to an existing file</p>
</li>
<li><p>When you have a loaded <code class="docutils literal notranslate"><span class="pre">sqw</span></code> object:</p>
<p>Apply the correction to the object</p>
</li>
<li><p>When you are still accumulating data (e.g. on the beamline):</p>
<p>Calculate what the goniometer offsets for regeneration</p>
</li>
</ul>
</section>
</section>
<section id="option-1-apply-the-correction-to-an-existing-sqw-file">
<h2><span class="section-number">4.2. </span>Option 1 : apply the correction to an existing sqw file<a class="headerlink" href="#option-1-apply-the-correction-to-an-existing-sqw-file" title="Permalink to this heading"></a></h2>
<p>There is a simple routine to apply the changes to an existing file, without the need to regenerate it from raw data</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">change_crystal</span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="n">alignment_info</span><span class="p">)</span>
</pre></div>
</div>
<p>where <code class="docutils literal notranslate"><span class="pre">alignment_info</span></code> was determined in the steps described above. From this point out the alignment will be applied whenever pixels are loaded or manipulated (e.g. loading, cutting, plotting, etc.).</p>
<p>Once you have confirmed that the alignment you have is the correct one, it is possible to fix the alignment to avoid this calculation step.</p>
<p>This is done through the <code class="docutils literal notranslate"><span class="pre">apply_alignment</span></code> function:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">wout</span><span class="p">,</span><span class="w"> </span><span class="n">rev_corr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">apply_alignment</span><span class="p">(</span><span class="n">win</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="s">&#39;-keep_original&#39;</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>You must have attached the alignment to the <code class="docutils literal notranslate"><span class="pre">sqw</span></code> through the <code class="docutils literal notranslate"><span class="pre">change_crystal</span></code> function prior to applying it.</p>
</div>
<p>Where:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">win</span></code> - Input filename or <code class="docutils literal notranslate"><span class="pre">sqw</span></code> object to update.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'-keep_original'</span></code> - In the case of a file-backed <code class="docutils literal notranslate"><span class="pre">sqw</span></code> object, this will avoid overwriting the original datafile and retain the temporary file created as part of the calculation process</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you use <code class="docutils literal notranslate"><span class="pre">'-keep_original'</span></code> you may wish to <code class="docutils literal notranslate"><span class="pre">save</span></code> your object as the temporary file will be cleared when the object is. (see: file_backed_objects)</p>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">wout</span></code> - Resulting <code class="docutils literal notranslate"><span class="pre">sqw</span></code> object or the filename to which the alignment was applied.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rev_corr</span></code> - A corresponding <code class="docutils literal notranslate"><span class="pre">crystal_alignment_info</span></code> to be able to reverse the application.</p></li>
</ul>
</section>
<section id="option-2-calculate-goniometer-offsets-for-regeneration-of-sqw-file-s">
<h2><span class="section-number">4.3. </span>Option 2 : calculate goniometer offsets for regeneration of sqw file(s)<a class="headerlink" href="#option-2-calculate-goniometer-offsets-for-regeneration-of-sqw-file-s" title="Permalink to this heading"></a></h2>
<p>In this case there is a single routine to calculate the new goniometer offsets, that can then be used in future sqw file generation.</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">alatt</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg</span><span class="p">,</span><span class="w"> </span><span class="n">dpsi_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gl_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gs_deg</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">crystal_pars_correct</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">alatt0</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg0</span><span class="p">,</span><span class="w"> </span><span class="n">omega0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">dpsi0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gl0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gs0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">al_info</span><span class="p">,</span><span class="w"> </span><span class="o">&lt;</span><span class="n">keyword</span><span class="w"> </span><span class="n">options</span><span class="o">&gt;</span><span class="p">)</span>
</pre></div>
</div>
<p>The inputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">u</span></code>, <code class="docutils literal notranslate"><span class="pre">v</span></code> - Two 3-vectors which were used to define the notional scattering plane before any alignment corrections
were performed.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">u</span></code> is usually defined as the vector of the incident beam and <code class="docutils literal notranslate"><span class="pre">v</span></code> is coplanar with respect to the instrument.</p>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alatt0</span></code>, <code class="docutils literal notranslate"><span class="pre">angdeg0</span></code> - The initial sample lattice parameters, before refinement</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">omega0_deg</span></code>, <code class="docutils literal notranslate"><span class="pre">dpsi0_deg</span></code>, <code class="docutils literal notranslate"><span class="pre">gl0_deg</span></code>, <code class="docutils literal notranslate"><span class="pre">gs0_deg</span></code> - The initial goniometer offsets, before refinement (all in
<span class="math notranslate nohighlight">\(^\circ\)</span>)</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><span class="math notranslate nohighlight">\(\text{d}\psi\)</span>, <span class="math notranslate nohighlight">\(g_l\)</span> and <span class="math notranslate nohighlight">\(g_s\)</span> refer to the Euler angles relative to the scattering plane. Naming
conventions may differ in other notations, e.g. <span class="math notranslate nohighlight">\(\theta, \phi, \chi\)</span>.</p>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">al_info</span></code> - The <code class="docutils literal notranslate"><span class="pre">crystal_alignment_info</span></code> object determined above.</p></li>
</ul>
<p>The keywords options are:</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Normally these need not be given and the inputs <code class="docutils literal notranslate"><span class="pre">u</span></code>, <code class="docutils literal notranslate"><span class="pre">v</span></code> and <code class="docutils literal notranslate"><span class="pre">omega</span></code> will be used.</p>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">u_new</span></code>, <code class="docutils literal notranslate"><span class="pre">v_new</span></code> - <span class="math notranslate nohighlight">\(\vec{u}\)</span>, <span class="math notranslate nohighlight">\(\vec{v}\)</span> that define the scattering plane. <span class="math notranslate nohighlight">\(d\psi\)</span>,
<span class="math notranslate nohighlight">\(g_{l}\)</span>, <span class="math notranslate nohighlight">\(g_{s}\)</span> will be calculated with respect to these vectors. (Default: <code class="docutils literal notranslate"><span class="pre">u</span></code>, <code class="docutils literal notranslate"><span class="pre">v</span></code> respectively)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">omega_new</span></code> - Value for the orientation of the virtual goniometer arcs. <span class="math notranslate nohighlight">\(d\psi\)</span>,
<span class="math notranslate nohighlight">\(g_{l}\)</span>, <span class="math notranslate nohighlight">\(g_{s}\)</span> will be calculated with respect to this offset angle. (Default: <code class="docutils literal notranslate"><span class="pre">omega</span></code>) (<span class="math notranslate nohighlight">\(^\circ\)</span>)</p></li>
</ul>
<p>The outputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">alatt,</span> <span class="pre">angdeg</span></code> - The true lattice parameters: <span class="math notranslate nohighlight">\([a_{true},b_{true},c_{true}]\)</span>,
<span class="math notranslate nohighlight">\([\alpha_{true},\beta_{true},\gamma_{true}]\)</span> (in Å and <span class="math notranslate nohighlight">\(^\circ\)</span> respectively)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dpsi_deg,</span> <span class="pre">gl_deg,</span> <span class="pre">gs_deg</span></code> - Misorientation angles of the vectors <code class="docutils literal notranslate"><span class="pre">u_new</span></code> and <code class="docutils literal notranslate"><span class="pre">v_new</span></code> (all in <span class="math notranslate nohighlight">\(^\circ\)</span>)</p></li>
</ul>
</section>
<section id="option-2a-for-use-with-e-g-mslice-calculate-the-true-u-and-v-for-your-misaligned-crystal">
<h2><span class="section-number">4.4. </span>Option 2a (for use with e.g. Mslice): calculate the true u and v for your misaligned crystal<a class="headerlink" href="#option-2a-for-use-with-e-g-mslice-calculate-the-true-u-and-v-for-your-misaligned-crystal" title="Permalink to this heading"></a></h2>
<p>Following option 2 above, you can recalculate the true <code class="docutils literal notranslate"><span class="pre">u</span></code> and <code class="docutils literal notranslate"><span class="pre">v</span></code> vectors with the following method:</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">u_true</span><span class="p">,</span><span class="w"> </span><span class="n">v_true</span><span class="p">,</span><span class="w"> </span><span class="n">rlu_corr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">uv_correct</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">alatt0</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg0</span><span class="p">,</span><span class="w"> </span><span class="n">omega_deg</span><span class="p">,</span><span class="w"> </span><span class="n">dpsi_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gl_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gs_deg</span><span class="p">,</span><span class="w"> </span><span class="n">alatt_true</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg_true</span><span class="p">)</span>
</pre></div>
</div>
<p>The inputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">u</span></code>, <code class="docutils literal notranslate"><span class="pre">v</span></code> - the orientation of the correctly aligned crystal.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alatt</span></code>, <code class="docutils literal notranslate"><span class="pre">angdeg</span></code> - the lattice parameters of the aligned crystal, i.e. the output of <code class="docutils literal notranslate"><span class="pre">crystal_pars_correct</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">omega_deg</span></code>, <code class="docutils literal notranslate"><span class="pre">dpsi_deg</span></code>, <code class="docutils literal notranslate"><span class="pre">gl_deg</span></code>, <code class="docutils literal notranslate"><span class="pre">gs_deg</span></code> - the calculated misorientation angles, i.e. the output of
<code class="docutils literal notranslate"><span class="pre">crystal_pars_correct</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">alatt_true</span></code>, <code class="docutils literal notranslate"><span class="pre">angdeg_true</span></code> - similarly, the calculated correct lattice parameters</p></li>
</ul>
<p>The outputs are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">u_true,</span> <span class="pre">v_true</span></code> - the corrected <span class="math notranslate nohighlight">\(\vec{u}\)</span> and <span class="math notranslate nohighlight">\(\vec{v}\)</span> for e.g. Mslice.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">rlu_corr</span></code> - the orientation correction matrix to go from the notional to the real crystal (see above)</p></li>
</ul>
<section id="list-of-alignment-correction-routines">
<h3><span class="section-number">4.4.1. </span>List of alignment correction routines<a class="headerlink" href="#list-of-alignment-correction-routines" title="Permalink to this heading"></a></h3>
<p>Below we provide a brief summary of the routines available for different aspects of alignment corrections. For further information type</p>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="nb">help</span><span class="w"> </span><span class="o">&lt;</span><span class="k">function</span><span class="w"> </span><span class="n">name</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>in the Matlab command window.</p>
</section>
</section>
<section id="id1">
<h2><span class="section-number">4.5. </span>bragg_positions<a class="headerlink" href="#id1" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">rlu0</span><span class="p">,</span><span class="nb">width</span><span class="p">,</span><span class="n">wcut</span><span class="p">,</span><span class="n">wpeak</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">bragg_positions</span><span class="p">(</span><span class="n">w</span><span class="p">,</span><span class="w"> </span><span class="n">rlu</span><span class="p">,</span><span class="w"> </span><span class="n">radial_cut_length</span><span class="p">,</span><span class="w"> </span><span class="n">radial_bin_width</span><span class="p">,</span><span class="w"> </span><span class="n">radial_thickness</span><span class="p">,</span><span class="k">...</span>
<span class="w">                                          </span><span class="n">trans_cut_length</span><span class="p">,</span><span class="w"> </span><span class="n">trans_bin_width</span><span class="p">,</span><span class="w"> </span><span class="n">trans_thickness</span><span class="p">)</span>
</pre></div>
</div>
<p>Get actual Bragg peak positions, given initial estimates of their positions, from an sqw object or file</p>
</section>
<section id="bragg-positions-view">
<h2><span class="section-number">4.6. </span>bragg_positions_view<a class="headerlink" href="#bragg-positions-view" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">bragg_positions_view</span><span class="p">(</span><span class="n">wcut</span><span class="p">,</span><span class="w"> </span><span class="n">wpeak</span><span class="p">)</span>
</pre></div>
</div>
<p>View the output of fitting to Bragg peaks performed by <code class="docutils literal notranslate"><span class="pre">bragg_positions</span></code></p>
</section>
<section id="crystal-pars-correct">
<h2><span class="section-number">4.7. </span>crystal_pars_correct<a class="headerlink" href="#crystal-pars-correct" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">alatt</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg</span><span class="p">,</span><span class="w"> </span><span class="n">dpsi_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gl_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gs_deg</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">crystal_pars_correct</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">alatt0</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg0</span><span class="p">,</span><span class="w"> </span><span class="n">omega0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">dpsi0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gl0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gs0_deg</span><span class="p">,</span><span class="w"> </span><span class="n">al_info</span><span class="p">)</span>
</pre></div>
</div>
<p>Return correct lattice parameters and crystal orientation for gen_sqw from a matrix that corrects the r.l.u.</p>
</section>
<section id="refine-crystal">
<h2><span class="section-number">4.8. </span>refine_crystal<a class="headerlink" href="#refine-crystal" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="n">al_info</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">refine_crystal</span><span class="p">(</span><span class="n">rlu0</span><span class="p">,</span><span class="w"> </span><span class="n">alatt0</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg0</span><span class="p">,</span><span class="w"> </span><span class="n">bragg_peaks</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="n">fix_</span><span class="p">])</span>
</pre></div>
</div>
<p>Refine crystal orientation and lattice parameters</p>
</section>
<section id="ubmatrix">
<h2><span class="section-number">4.9. </span>ubmatrix<a class="headerlink" href="#ubmatrix" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">ub</span><span class="p">,</span><span class="w"> </span><span class="n">mess</span><span class="p">,</span><span class="w"> </span><span class="n">umat</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">ubmatrix</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">)</span>
</pre></div>
</div>
<p>Calculate UB matrix that transforms components of a vector given in r.l.u. into the components in an orthonormal frame
defined by the two vectors u and v (each given in r.l.u)</p>
</section>
<section id="uv-correct">
<h2><span class="section-number">4.10. </span>uv_correct<a class="headerlink" href="#uv-correct" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">u_true</span><span class="p">,</span><span class="w"> </span><span class="n">v_true</span><span class="p">,</span><span class="w"> </span><span class="n">rlu_corr</span><span class="p">]</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="n">uv_correct</span><span class="w"> </span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">alatt0</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg0</span><span class="p">,</span><span class="w"> </span><span class="n">omega_deg</span><span class="p">,</span><span class="w"> </span><span class="n">dpsi_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gl_deg</span><span class="p">,</span><span class="w"> </span><span class="n">gs_deg</span><span class="p">,</span><span class="w"> </span><span class="n">alatt_true</span><span class="p">,</span><span class="w"> </span><span class="n">angdeg_true</span><span class="p">)</span>
</pre></div>
</div>
<p>Calculate the correct u and v vectors for a misaligned crystal, for use e.g. with Mslice.</p>
</section>
<section id="rlu-corr-to-lattice">
<h2><span class="section-number">4.11. </span>rlu_corr_to_lattice<a class="headerlink" href="#rlu-corr-to-lattice" title="Permalink to this heading"></a></h2>
<div class="highlight-matlab notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">alatt</span><span class="p">,</span><span class="n">angdeg</span><span class="p">,</span><span class="n">rotmat</span><span class="p">,</span><span class="n">ok</span><span class="p">,</span><span class="n">mess</span><span class="p">]=</span><span class="n">rlu_corr_to_lattice</span><span class="p">(</span><span class="n">rlu_corr</span><span class="p">,</span><span class="n">alatt0</span><span class="p">,</span><span class="n">angdeg0</span><span class="p">)</span>
</pre></div>
</div>
<p>Extract lattice parameters and orientation matrix from r.l.u correction matrix and reference lattice parameters</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="Data_diagnostics.html" class="btn btn-neutral float-left" title="3. Data diagnostics" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="Cutting_data_of_interest_from_SQW_files_and_objects.html" class="btn btn-neutral float-right" title="5. Cutting data of interest from SQW files and objects" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2006-2024, STFC RAL.
      <span class="lastupdated">Last updated on Apr 19, 2024, 1:54:19 PM.
      </span></p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
<br><br>
<a href="https://github.com/pace-neutrons/Horace/edit/master/documentation/user_docs/docs/manual/Correcting_for_sample_misalignment.rst">Click here to edit</a> or <a href="https://github.com/pace-neutrons/Horace/edit/master/documentation/user_docs/docs/new_page.rst">Click here to add new page</a> (requires <a href="https://github.com/login">GitHub account</a>).
<br>
For more info on editing <a href="../Contributing.html">click here</a>.


</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>